

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>humancompatible.explain.fcx.scripts.evaluation_functions_adult &mdash; HumanCompatible.Explain  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            HumanCompatible.Explain
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../facts.html">FACTS: Fairness Aware Counterfactual for Subgrouos package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../glance.html">GLANCE: Global Actions in a Nutshell for Counterfactual Explainability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../fcx.html">FCX: Finding Feasible Counterfactual Explanation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">HumanCompatible.Explain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">humancompatible.explain.fcx.scripts.evaluation_functions_adult</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for humancompatible.explain.fcx.scripts.evaluation_functions_adult</h1><div class="highlight"><pre>
<span></span><span class="c1"># ------------------- LIBRARIES ------------------- </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scripts.fcx_vae_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">FCX_VAE</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.utils.data</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">optim</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.autograd</span><span class="w"> </span><span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow</span><span class="w"> </span><span class="kn">import</span> <span class="n">keras</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.layers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">,</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">Multiply</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Sequential</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tensorflow.keras</span><span class="w"> </span><span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="c1">#Seed for repoduability</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">10000000</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalOutlierFactor</span>

<span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span>
<span class="c1"># ------------------- FEATURE NAMES ------------------- </span>

<span class="n">education_change</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HS-grad&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Some-college&#39;</span><span class="p">,</span> <span class="s1">&#39;Bachelors&#39;</span><span class="p">,</span> <span class="s1">&#39;Assoc&#39;</span><span class="p">,</span> <span class="s1">&#39;Prof-school&#39;</span><span class="p">,</span> <span class="s1">&#39;Masters&#39;</span><span class="p">,</span> <span class="s1">&#39;Doctorate&#39;</span><span class="p">],</span>
        <span class="s1">&#39;School&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Some-college&#39;</span><span class="p">,</span> <span class="s1">&#39;Bachelors&#39;</span><span class="p">,</span> <span class="s1">&#39;Assoc&#39;</span><span class="p">,</span> <span class="s1">&#39;Prof-school&#39;</span><span class="p">,</span> <span class="s1">&#39;Masters&#39;</span><span class="p">,</span> <span class="s1">&#39;Doctorate&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Bachelors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prof-school&#39;</span><span class="p">,</span> <span class="s1">&#39;Masters&#39;</span><span class="p">,</span> <span class="s1">&#39;Doctorate&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Assoc&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prof-school&#39;</span><span class="p">,</span> <span class="s1">&#39;Masters&#39;</span><span class="p">,</span> <span class="s1">&#39;Doctorate&#39;</span><span class="p">]</span> <span class="p">,</span>
        <span class="s1">&#39;Some-college&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Prof-school&#39;</span><span class="p">,</span> <span class="s1">&#39;Masters&#39;</span><span class="p">,</span> <span class="s1">&#39;Doctorate&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Masters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Doctorate&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Prof-school&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Doctorate&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Doctorate&#39;</span><span class="p">:</span> <span class="p">[]</span> <span class="p">}</span>

<span class="n">education_score</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HS-grad&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;School&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;Bachelors&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;Assoc&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;Some-college&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;Masters&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;Prof-school&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;Doctorate&#39;</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>

<span class="n">encoded_feature_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hours_per_week&#39;</span><span class="p">,</span>
 <span class="s1">&#39;workclass_Government&#39;</span><span class="p">,</span>
 <span class="s1">&#39;workclass_Other/Unknown&#39;</span><span class="p">,</span>
 <span class="s1">&#39;workclass_Private&#39;</span><span class="p">,</span>
 <span class="s1">&#39;workclass_Self-Employed&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_Assoc&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_Bachelors&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_Doctorate&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_HS-grad&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_Masters&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_Prof-school&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_School&#39;</span><span class="p">,</span>
 <span class="s1">&#39;education_Some-college&#39;</span><span class="p">,</span>
 <span class="s1">&#39;marital_status_Divorced&#39;</span><span class="p">,</span>
 <span class="s1">&#39;marital_status_Married&#39;</span><span class="p">,</span>
 <span class="s1">&#39;marital_status_Separated&#39;</span><span class="p">,</span>
 <span class="s1">&#39;marital_status_Single&#39;</span><span class="p">,</span>
 <span class="s1">&#39;marital_status_Widowed&#39;</span><span class="p">,</span>
 <span class="s1">&#39;occupation_Blue-Collar&#39;</span><span class="p">,</span>
 <span class="s1">&#39;occupation_Other/Unknown&#39;</span><span class="p">,</span>
 <span class="s1">&#39;occupation_Professional&#39;</span><span class="p">,</span>
 <span class="s1">&#39;occupation_Sales&#39;</span><span class="p">,</span>
 <span class="s1">&#39;occupation_Service&#39;</span><span class="p">,</span>
 <span class="s1">&#39;occupation_White-Collar&#39;</span><span class="p">,</span>
 <span class="s1">&#39;race_Other&#39;</span><span class="p">,</span>
 <span class="s1">&#39;race_White&#39;</span><span class="p">,</span>
 <span class="s1">&#39;gender_Female&#39;</span><span class="p">,</span>
 <span class="s1">&#39;gender_Male&#39;</span><span class="p">]</span>
<span class="n">ed_dict</span><span class="o">=</span><span class="p">{}</span>
<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">education_score</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">ed_dict</span><span class="p">[</span><span class="n">encoded_feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;education_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">)]</span><span class="o">=</span> <span class="n">education_score</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ed_dict</span><span class="p">)</span>


<span class="c1"># ------------------- HELPER FUNCTIONS ------------------- </span>
    
<div class="viewcode-block" id="de_normalise">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.de_normalise">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">de_normalise</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">normalise_weights</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map a normalized feature value back to its original scale.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (float or array-like):</span>
<span class="sd">            The normalized value(s) in the range [0, 1].</span>
<span class="sd">        normalise_weights (tuple[float, float]):</span>
<span class="sd">            A `(min, max)` tuple giving the original feature’s range.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float or array-like:</span>
<span class="sd">            The de-normalized value(s), scaled back to [min, max].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">normalise_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="de_scale">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.de_scale">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">de_scale</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">normalise_weights</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the absolute scale (range) of a normalized value.</span>

<span class="sd">    Given a normalized offset `x` in [0, 1], and a feature’s original</span>
<span class="sd">    `(min, max)` range, returns the corresponding absolute difference.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (float):</span>
<span class="sd">            The normalized offset (e.g., 0.05 represents 5% of the range).</span>
<span class="sd">        normalise_weights (tuple[float, float]):</span>
<span class="sd">            A `(min, max)` tuple for the feature’s original range.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float:</span>
<span class="sd">            The absolute offset in the original scale (i.e., `(max - min) * x`).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">normalise_weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">x</span></div>




<span class="c1"># ------------------- VALIDITY METRIC ------------------- </span>
<div class="viewcode-block" id="validity_score">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.validity_score">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validity_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the validity of generated counterfactuals as the percentage that</span>
<span class="sd">    successfully flip the black‑box classifier’s prediction.</span>

<span class="sd">    For each `sample_size` in `sample_range`, this function:</span>
<span class="sd">      1. Generates `sample_size` counterfactuals per example via `model.compute_elbo`,</span>
<span class="sd">         conditioned on the opposite class from `pred_model`.</span>
<span class="sd">      2. Applies `pred_model` to each generated counterfactual.</span>
<span class="sd">      3. Computes the fraction of counterfactuals whose predicted label</span>
<span class="sd">         differs from the original label.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (FCX_VAE):</span>
<span class="sd">            Trained counterfactual VAE providing `compute_elbo(...)`.</span>
<span class="sd">        pred_model (BlackBox):</span>
<span class="sd">            Pre‑trained classifier used to judge validity of counterfactuals.</span>
<span class="sd">        train_dataset (np.ndarray):</span>
<span class="sd">            Array of original examples with labels, shape (N, d+1).</span>
<span class="sd">        case (int or bool):</span>
<span class="sd">            If truthy, may trigger optional plotting (unused by default).</span>
<span class="sd">        sample_range (list[int]):</span>
<span class="sd">            Monte Carlo sample counts to evaluate (e.g., [1, 2, 3]).</span>
<span class="sd">        d (DataLoader, optional):</span>
<span class="sd">            DataLoader instance for decoding or de-normalizing data</span>
<span class="sd">            (if needed).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[float]:</span>
<span class="sd">            Validity percentages (0–100)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cf_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;x_cf&#39;</span><span class="p">,</span>  <span class="s1">&#39;label_cf&#39;</span><span class="p">])</span>
    <span class="n">x_pred_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">validity_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sample range: &quot;</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">)</span>
    <span class="c1">#sample_range=[1]</span>
    <span class="k">for</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="n">sample_range</span><span class="p">:</span>
        <span class="n">train_x</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">train_dataset</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
        <span class="n">train_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">pred_model</span><span class="p">(</span><span class="n">train_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>                
        <span class="n">valid_cf_count</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">sample_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>        
            <span class="n">recon_err</span><span class="p">,</span> <span class="n">kl_err</span><span class="p">,</span> <span class="n">x_true</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_elbo</span><span class="p">(</span> <span class="n">train_x</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">train_y</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span><span class="kc">True</span> <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;sample iter &quot;</span><span class="p">,</span><span class="n">sample_iter</span><span class="p">)</span>

            <span class="c1">#add x train and x pred to dataframe</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
                <span class="n">x_pred2</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>
                <span class="n">x_true2</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>                
            
            <span class="n">x_pred2</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf_label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">x_true2</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="n">cf_label</span> <span class="o">=</span> <span class="n">cf_label</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">valid_cf_count</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">train_y</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">!=</span> <span class="n">cf_label</span> <span class="p">)</span>
            
        <span class="n">test_size</span><span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">valid_cf_count</span><span class="o">=</span><span class="n">valid_cf_count</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">validity_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">valid_cf_count</span><span class="o">/</span><span class="n">test_size</span><span class="p">)</span>
    
    <span class="c1"># concatenate arrays in the list</span>
    <span class="n">x_true2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;x_true_binary_lof.csv&quot;</span><span class="p">)</span>
    <span class="n">x_pred2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;x_pred_binary_lof.csv&quot;</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
    <span class="n">z</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;z_pred__binary_lof.csv&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;if case:</span>
<span class="sd">        plt.plot(sample_range, validity_score_arr)</span>
<span class="sd">        plt.title(&#39;Valid CF&#39;)</span>
<span class="sd">        plt.xlabel(&#39;Sample Size&#39;)</span>
<span class="sd">        plt.ylabel(&#39;Percentage of CF&#39;)</span>
<span class="sd">        plt.show()&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Validity Score: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">validity_score_arr</span><span class="p">))</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">validity_score_arr</span></div>


<span class="c1"># ------------------- PROXIMITY METRIC ------------------- </span>
<div class="viewcode-block" id="proximity_score">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.proximity_score">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">proximity_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">mad_feature_weights</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute continuous or categorical L1 proximity between originals and counterfactuals.</span>

<span class="sd">    For each `sample_size` in `sample_range`, this function:</span>
<span class="sd">      1. Generates `sample_size` counterfactuals per example via `model.compute_elbo`,</span>
<span class="sd">         conditioned to flip `pred_model`’s output.</span>
<span class="sd">      2. De-normalizes both originals (`x_true`) and counterfactuals (`x_pred`) using</span>
<span class="sd">         `d.get_decoded_data` and `d.de_normalize_data`.</span>
<span class="sd">      3. Computes L1 distances:</span>
<span class="sd">         - If `cat` is False: sums absolute differences over continuous features.</span>
<span class="sd">         - If `cat` is True: sums absolute differences over one-hot encoded categorical features.</span>
<span class="sd">      4. Averages distances across MC samples and examples.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (FCX_VAE):</span>
<span class="sd">            Trained counterfactual VAE providing `compute_elbo(...)`.</span>
<span class="sd">        pred_model (BlackBox):</span>
<span class="sd">            Pre‑trained classifier for validity conditioning.</span>
<span class="sd">        train_dataset (np.ndarray):</span>
<span class="sd">            Array of original examples with labels, shape (N, d+1).</span>
<span class="sd">        d (DataLoader):</span>
<span class="sd">            DataLoader instance for decoding and de-normalizing features.</span>
<span class="sd">        mad_feature_weights (dict[int, float]):</span>
<span class="sd">            Mean absolute deviation weights for continuous features.</span>
<span class="sd">        cat (bool):</span>
<span class="sd">            If False, compute continuous proximity; if True, compute categorical proximity.</span>
<span class="sd">        case (int or bool):</span>
<span class="sd">            If truthy, may trigger plotting (unused by default).</span>
<span class="sd">        sample_range (list[int]):</span>
<span class="sd">            Monte Carlo sample counts to evaluate (e.g., [1, 2, 3]).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[float]:</span>
<span class="sd">            Proximity scores (average L1 distances)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prox_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="n">sample_range</span><span class="p">:</span>
        <span class="n">train_x</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">train_dataset</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
        <span class="n">train_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">pred_model</span><span class="p">(</span><span class="n">train_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>                
        <span class="n">prox_count</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">sample_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>        
            <span class="n">recon_err</span><span class="p">,</span> <span class="n">kl_err</span><span class="p">,</span> <span class="n">x_true</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_elbo</span><span class="p">(</span> <span class="n">train_x</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">train_y</span><span class="p">,</span> <span class="n">pred_model</span> <span class="p">,</span><span class="kc">True</span><span class="p">)</span>            
            
            <span class="n">x_pred</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>
            <span class="n">x_true</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>   
             
            <span class="k">if</span> <span class="n">cat</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">categorical_feature_names</span><span class="p">:</span>
                    <span class="n">prox_count</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_true</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_pred</span><span class="p">[</span><span class="n">column</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">continuous_feature_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;wage_per_hour&#39;</span><span class="p">,</span> <span class="s1">&#39;capital_gains&#39;</span><span class="p">,</span><span class="s1">&#39;capital_losses&#39;</span><span class="p">,</span><span class="s1">&#39;dividends_from_stocks&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">prox_count</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_true</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_pred</span><span class="p">[</span><span class="n">column</span><span class="p">]))</span><span class="o">/</span><span class="n">mad_feature_weights</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>                
                    
        <span class="n">test_size</span><span class="o">=</span> <span class="n">train_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">prox_count</span><span class="o">=</span> <span class="n">prox_count</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">prox_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">prox_count</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;plt.plot(sample_range, prox_score_arr)</span>
<span class="sd">        if cat:</span>
<span class="sd">            plt.title(&#39;Categorical Proximity&#39;)</span>
<span class="sd">        else:</span>
<span class="sd">            plt.title(&#39;Continuous Proximity&#39;)</span>

<span class="sd">        plt.xlabel(&#39;Sample Size&#39;)</span>
<span class="sd">        plt.ylabel(&#39;Magnitude&#39;)</span>
<span class="sd">        plt.show()&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Proximity Score: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prox_score_arr</span><span class="p">))</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">prox_score_arr</span></div>



<span class="c1"># ------------------- BINARY CONSTRAINT ------------------- </span>
<div class="viewcode-block" id="causal_score_age_ed_constraint">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.causal_score_age_ed_constraint">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">causal_score_age_ed_constraint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute feasibility scores based on age and education monotonicity constraints for binary counterfactuals.</span>

<span class="sd">    For each `sample_size` in `sample_range`, this function:</span>
<span class="sd">      1. Generates `sample_size` counterfactuals per example via `model.compute_elbo`, conditioned to flip `pred_model`’s output.</span>
<span class="sd">      2. De-normalizes counterfactuals (`x_pred`) and originals (`x_true`) with `d.get_decoded_data` and `d.de_normalize_data`.</span>
<span class="sd">      3. Checks two monotonic constraints for each counterfactual:</span>
<span class="sd">         - **Age constraint**: CF age ≥ original age + de-scaled `offset`.</span>
<span class="sd">         - **Education constraint**: CF education level ≥ original education level + de-scaled `offset`.</span>
<span class="sd">      4. Computes the percentage of valid vs. invalid counterfactuals for each `sample_size`.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (FCX_VAE):</span>
<span class="sd">            Trained counterfactual VAE model providing `compute_elbo(...)`.</span>
<span class="sd">        pred_model (BlackBox):</span>
<span class="sd">            Pre‑trained classifier used to determine target labels.</span>
<span class="sd">        train_dataset (np.ndarray):</span>
<span class="sd">            Array of original examples with labels, shape (N, d+1).</span>
<span class="sd">        d (DataLoader):</span>
<span class="sd">            DataLoader instance for decoding and de-normalizing features.</span>
<span class="sd">        normalise_weights (dict[int, tuple(float, float)]):</span>
<span class="sd">            Per-feature (min, max) values for scaling/offset computations.</span>
<span class="sd">        offset (float):</span>
<span class="sd">            Raw offset applied when checking monotonic constraints.</span>
<span class="sd">        case (int or bool):</span>
<span class="sd">            If truthy, may trigger optional plotting (unused by default).</span>
<span class="sd">        sample_range (list[int]):</span>
<span class="sd">            Monte Carlo sample counts to evaluate (e.g., [1, 2, 3]).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            - valid_score_arr (list[float]): Percentage of counterfactuals satisfying</span>
<span class="sd">              both age and education constraints, for each `sample_size`.</span>
<span class="sd">            - invalid_score_arr (list[float]): Percentage violating at least one</span>
<span class="sd">              constraint, for each `sample_size`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">invalid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">count1</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">count2</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">count3</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pos1</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pos2</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pos3</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="n">sample_range</span><span class="p">:</span>
        <span class="n">train_x</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">train_dataset</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
        <span class="n">train_y</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">pred_model</span><span class="p">(</span><span class="n">train_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>                
        <span class="n">valid_change</span><span class="o">=</span> <span class="mi">0</span>
        <span class="n">invalid_change</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">test_size</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">sample_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>        
            <span class="n">recon_err</span><span class="p">,</span> <span class="n">kl_err</span><span class="p">,</span> <span class="n">x_true</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">,</span><span class="n">z</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_elbo</span><span class="p">(</span> <span class="n">train_x</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">train_y</span><span class="p">,</span> <span class="n">pred_model</span> <span class="p">,</span><span class="kc">True</span><span class="p">)</span>            
            
            <span class="n">x_pred</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>
            <span class="n">x_true</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>                

            <span class="n">ed_idx</span> <span class="o">=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;education&#39;</span><span class="p">)</span>
            <span class="n">age_idx</span> <span class="o">=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>            

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> 
                
                <span class="k">if</span> <span class="n">cf_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>                
                <span class="n">test_size</span><span class="o">+=</span><span class="mi">1</span>
                
                <span class="k">if</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]</span> <span class="o">&lt;</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]:</span>
                    <span class="n">count3</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">invalid_change</span> <span class="o">+=</span><span class="mi">1</span>       
                <span class="k">elif</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]</span> <span class="o">==</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]:</span>
                    <span class="n">count1</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">de_scale</span><span class="p">(</span> <span class="n">offset</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]:</span>
                        <span class="n">pos1</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">valid_change</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">invalid_change</span> <span class="o">+=</span><span class="mi">1</span>                    
                <span class="k">elif</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]:</span>
                    <span class="n">count2</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">de_scale</span><span class="p">(</span> <span class="n">offset</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]:</span>
                        <span class="n">pos2</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">valid_change</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">invalid_change</span> <span class="o">+=</span><span class="mi">1</span>

        <span class="n">valid_change</span><span class="o">=</span> <span class="n">valid_change</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">invalid_change</span><span class="o">=</span> <span class="n">invalid_change</span><span class="o">/</span><span class="n">sample_size</span>

        <span class="n">test_size</span><span class="o">=</span> <span class="n">test_size</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">valid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">valid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>
        <span class="n">invalid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">invalid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>

    <span class="n">valid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_score_arr</span><span class="p">))</span>
    <span class="n">invalid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">invalid_score_arr</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;plt.plot(sample_range, valid_score_arr, &#39;*&#39;, label=&#39;Val Change&#39;)</span>
<span class="sd">        plt.plot(sample_range, invalid_score_arr, &#39;s&#39;, label=&#39;Inval Change&#39;)</span>
<span class="sd">        plt.legend(loc=&#39;upper left&#39;)</span>
<span class="sd">        plt.ylim(ymin=0, ymax=100)</span>
<span class="sd">        plt.title(&#39;All Education Levels&#39;)</span>
<span class="sd">        plt.xlabel(&#39;Sample Size&#39;)</span>
<span class="sd">        plt.ylabel(&#39;Percentage of CF&#39;)</span>
<span class="sd">        plt.show()&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Age-Ed Constraint Score: &#39;</span><span class="p">,</span> <span class="n">valid_score</span><span class="p">,</span> <span class="n">invalid_score</span><span class="p">,</span> <span class="n">valid_score</span><span class="o">/</span><span class="p">(</span><span class="n">valid_score</span><span class="o">+</span><span class="n">invalid_score</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Count: &#39;</span><span class="p">,</span> <span class="n">count1</span><span class="p">,</span> <span class="n">count2</span><span class="p">,</span> <span class="n">count3</span><span class="p">,</span> <span class="n">count1</span><span class="o">+</span><span class="n">count2</span><span class="o">+</span><span class="n">count3</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pos Count: &#39;</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">pos3</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">count1</span> <span class="ow">and</span> <span class="n">count2</span> <span class="ow">and</span> <span class="n">count3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pos Percentage: &#39;</span><span class="p">,</span> <span class="n">pos1</span><span class="o">/</span><span class="n">count1</span><span class="p">,</span> <span class="n">pos2</span><span class="o">/</span><span class="n">count2</span><span class="p">,</span> <span class="n">pos3</span><span class="o">/</span><span class="n">count3</span> <span class="p">)</span>    
    <span class="k">return</span> <span class="n">valid_score_arr</span><span class="p">,</span> <span class="n">invalid_score_arr</span></div>



<div class="viewcode-block" id="lof_score_func">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.lof_score_func">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lof_score_func</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the average Local Outlier Factor (LOF) anomaly score for a dataset.</span>

<span class="sd">    This function fits a LocalOutlierFactor model (with 20 neighbors and</span>
<span class="sd">    Euclidean distance) on the input data and returns the mean LOF score</span>
<span class="sd">    across all samples. Higher LOF scores indicate a greater degree of</span>
<span class="sd">    anomaly.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (array-like of shape (n_samples, n_features)):</span>
<span class="sd">            The input data on which to compute anomaly scores.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float:</span>
<span class="sd">            The average LOF anomaly score (mean of `-negative_outlier_factor_`)</span>
<span class="sd">            over all samples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_outliers</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Split the data into train and test sets</span>
    <span class="c1">#X_train, X_test = train_test_split(data, test_size=0.01, random_state=42)</span>
    <span class="n">X_train</span><span class="o">=</span><span class="n">data</span>
    <span class="n">k_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="c1"># Initialize LOF with the current k value</span>
    <span class="n">lof</span> <span class="o">=</span> <span class="n">LocalOutlierFactor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span> <span class="c1">#, contamination=contamination</span>
    
    <span class="c1"># Fit the LOF model and get the outlier scores</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">lof</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">lof_scores</span> <span class="o">=</span> <span class="o">-</span><span class="n">lof</span><span class="o">.</span><span class="n">negative_outlier_factor_</span>  <span class="c1"># Higher scores = more likely to be outliers</span>
    
    <span class="c1"># Calculate the number of outliers detected in the training set</span>
    <span class="n">num_outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Average LOF score (mean anomaly score)</span>
    <span class="n">avg_lof_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lof_scores</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">avg_lof_score</span><span class="c1">#, num_outliers</span></div>


<span class="c1"># ------------------- BINARY CONSTRAINT + LOF ------------------- </span>
<div class="viewcode-block" id="causal_score_age_ed_constraint_lof">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.causal_score_age_ed_constraint_lof">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">causal_score_age_ed_constraint_lof</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">,</span><span class="n">prefix_name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a combined age and education constraint violation penalty with LOF anomaly score for binary counterfactuals.</span>

<span class="sd">    For each `sample_size` in `sample_range`, this function:</span>
<span class="sd">      1. Generates `sample_size` counterfactuals per example via `model.compute_elbo`, conditioned to flip `pred_model`’s output.</span>
<span class="sd">      2. De-normalizes the counterfactuals and originals using `d.get_decoded_data` and `d.de_normalize_data`.</span>
<span class="sd">      3. Evaluates two monotonic constraints:</span>
<span class="sd">         - **Age constraint**: CF age ≥ original age + de-scaled `offset`.</span>
<span class="sd">         - **Education constraint**: CF education level ≥ original education level (using `offset` and `normalise_weights`).</span>
<span class="sd">      4. Computes a Local Outlier Factor (LOF) anomaly score on the VAE’s latent codes.</span>
<span class="sd">      5. Combines the two constraint violation rates with the LOF score into a single numeric score per example.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (FCX_VAE):</span>
<span class="sd">            Trained counterfactual VAE model.</span>
<span class="sd">        pred_model (BlackBox):</span>
<span class="sd">            Pre‑trained classifier used for validity conditioning.</span>
<span class="sd">        train_dataset (np.ndarray):</span>
<span class="sd">            Array of examples + labels, shape (N, d+1).</span>
<span class="sd">        d (DataLoader):</span>
<span class="sd">            DataLoader instance for de-coding and de-normalizing features.</span>
<span class="sd">        normalise_weights (dict[int, tuple(float, float)]):</span>
<span class="sd">            Per-feature (min, max) values for scaling.</span>
<span class="sd">        offset (float):</span>
<span class="sd">            Raw offset applied when checking monotonic constraints.</span>
<span class="sd">        case (int or bool):</span>
<span class="sd">            If truthy, may trigger plotting (unused by default).</span>
<span class="sd">        sample_range (list[int]):</span>
<span class="sd">            Monte Carlo sample counts to evaluate (e.g., [1, 2, 3]).</span>
<span class="sd">        prefix_name (str, optional):</span>
<span class="sd">            Prefix for any saved outputs or logs (default: &#39;test&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[float]:</span>
<span class="sd">            LOF score</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">invalid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">count1</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">count2</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">count3</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pos1</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pos2</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">pos3</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">full_lof</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="n">sample_range</span><span class="p">:</span>
        <span class="n">train_x</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">train_dataset</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
        <span class="n">train_y</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">pred_model</span><span class="p">(</span><span class="n">train_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>                
        <span class="n">valid_change</span><span class="o">=</span> <span class="mi">0</span>
        <span class="n">invalid_change</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">test_size</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">sample_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>        
            <span class="n">recon_err</span><span class="p">,</span> <span class="n">kl_err</span><span class="p">,</span> <span class="n">x_true</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">,</span><span class="n">z</span><span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_elbo</span><span class="p">(</span> <span class="n">train_x</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">train_y</span><span class="p">,</span> <span class="n">pred_model</span> <span class="p">,</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#copy tensor</span>
            <span class="n">x_pred_norm</span> <span class="o">=</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>         
            <span class="n">feas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">x_pred</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>
            <span class="n">x_true</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>                

            <span class="n">ed_idx</span> <span class="o">=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;education&#39;</span><span class="p">)</span>
            <span class="n">age_idx</span> <span class="o">=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>            

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> 
                
                <span class="k">if</span> <span class="n">cf_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="c1">#print(cf_label[i])</span>
                    <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>                
                <span class="n">test_size</span><span class="o">+=</span><span class="mi">1</span>
                
                <span class="k">if</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]</span> <span class="o">&lt;</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]:</span>
                    <span class="n">count3</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">invalid_change</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>       
                <span class="k">elif</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]</span> <span class="o">==</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]:</span>
                    <span class="n">count1</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">de_scale</span><span class="p">(</span> <span class="n">offset</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]:</span>
                        <span class="n">pos1</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">valid_change</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">invalid_change</span> <span class="o">+=</span><span class="mi">1</span>    
                        <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                
                <span class="k">elif</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]</span> <span class="o">&gt;</span> <span class="n">education_score</span><span class="p">[</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">ed_idx</span><span class="p">]</span> <span class="p">]:</span>
                    <span class="n">count2</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">de_scale</span><span class="p">(</span> <span class="n">offset</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]:</span>
                        <span class="n">pos2</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="n">valid_change</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">invalid_change</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">feas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feas</span><span class="p">)</span>
            <span class="n">num_all</span> <span class="o">=</span> <span class="n">feas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">x_pred_norm</span> <span class="o">=</span> <span class="n">x_pred_norm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="n">x_pred_norm</span> <span class="o">=</span> <span class="n">x_pred_norm</span><span class="p">[</span><span class="n">feas</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">feas</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lof_score_val</span> <span class="o">=</span> <span class="n">lof_score_func</span><span class="p">(</span><span class="n">x_pred_norm</span><span class="p">)</span>
            <span class="c1">#lof_score_val = lof_score_func(x_pred_norm)</span>

            <span class="n">x_pred</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf_label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">x_true</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">x_true</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span> <span class="o">+</span> <span class="s2">&quot;_x_true.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">x_pred</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span> <span class="o">+</span> <span class="s2">&quot;_x_pred.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span><span class="o">+</span><span class="s2">&quot;_z_pred.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">xprednorm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_pred_norm</span><span class="p">)</span>
            <span class="n">xprednorm</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span><span class="o">+</span><span class="s2">&quot;_x_pred_norm.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&gt;&gt; Average lof score </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lof_score_val</span><span class="p">))</span>
            
            <span class="c1">#plot with tsne import tsne</span>
            <span class="c1">#lof = LocalOutlierFactor(n_neighbors=6, metric=&#39;euclidean&#39;)</span>
            <span class="c1">#lof_scores= lof.fit_predict(x_pred_norm) # tha mporouse kai gia x_true na ypologistei</span>


            <span class="c1"># PLOT lof score for different k</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;k_lof_results=[]</span>
<span class="sd">            k_lof_values=[]</span>
<span class="sd">            for k in range(1,200,1):</span>
<span class="sd">                lof = LocalOutlierFactor(n_neighbors=k, metric=&#39;euclidean&#39;)</span>
<span class="sd">                lof_scores= lof.fit_predict(x_pred_norm) # tha mporouse kai gia x_true na ypologistei</span>
<span class="sd">                temp_lof_score = np.sum(lof_scores==-1)</span>
<span class="sd">                k_lof_values.append(np.mean(lof.negative_outlier_factor_))</span>
<span class="sd">                k_lof_results.append(temp_lof_score)</span>
<span class="sd">            </span>
<span class="sd">            k_range = [*range(1,200,1)]</span>
<span class="sd">            print(&quot;k_lof_results&quot;, k_lof_results)</span>
<span class="sd">            plt.figure()</span>
<span class="sd">            plt.plot(k_range, k_lof_values)</span>
<span class="sd">            plt.title(&#39;LOF CF&#39;)</span>
<span class="sd">            plt.xlabel(&#39;k&#39;)</span>
<span class="sd">            plt.ylabel(&#39;LOF&#39;)</span>
<span class="sd">            #plt.show()</span>
<span class="sd">            plt.savefig(prefix_name+&quot;_lof_b.png&quot;)</span>
<span class="sd">            #save k_range and k_lof_results to pandas datafframe</span>
<span class="sd">            df = pd.DataFrame(list(zip(k_range, k_lof_results,k_lof_values)), columns =[&#39;k&#39;,&#39;num_outliers&#39;,&#39;lof&#39;])</span>
<span class="sd">            df.to_csv(prefix_name+&quot;_lof_k_b.csv&quot;,index=False)&quot;&quot;&quot;</span>

            <span class="n">full_lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lof_score_val</span><span class="p">)</span>

        <span class="n">valid_change</span><span class="o">=</span> <span class="n">valid_change</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">invalid_change</span><span class="o">=</span> <span class="n">invalid_change</span><span class="o">/</span><span class="n">sample_size</span>

        <span class="n">test_size</span><span class="o">=</span> <span class="n">test_size</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">valid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">valid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>
        <span class="n">invalid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">invalid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>

    <span class="n">valid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_score_arr</span><span class="p">))</span> 
    <span class="n">invalid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">invalid_score_arr</span><span class="p">))</span>
    <span class="n">full_lof_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">full_lof</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final average lof score&quot;</span><span class="p">,</span> <span class="n">full_lof_score</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">full_lof</span></div>


<span class="c1"># ------------------- UNARY CONSTRAINT ------------------- </span>
<div class="viewcode-block" id="causal_score_age_constraint">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.causal_score_age_constraint">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">causal_score_age_constraint</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute feasibility scores based on a monotonic age constraint for counterfactuals.</span>

<span class="sd">    For each `sample_size` in `sample_range`, this function:</span>
<span class="sd">      1. Calls `model.compute_elbo` to generate `sample_size` counterfactuals per example.</span>
<span class="sd">      2. De-normalizes predictions (`x_pred`) and originals (`x_true`) via the `DataLoader`.</span>
<span class="sd">      3. Checks that the counterfactual age ≥ original age plus a scaled `offset`.</span>
<span class="sd">      4. Computes the percentage of valid and invalid age‐constraint satisfactions.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (FCX_VAE):</span>
<span class="sd">            The trained counterfactual VAE, providing `compute_elbo(...)`.</span>
<span class="sd">        pred_model (BlackBox):</span>
<span class="sd">            Pre‑trained classifier used to determine target labels.</span>
<span class="sd">        train_dataset (np.ndarray):</span>
<span class="sd">            Array of shape (N, d+1), where the last column is the true label.</span>
<span class="sd">        d (DataLoader):</span>
<span class="sd">            DataLoader instance with methods:</span>
<span class="sd">              - `get_decoded_data(...)` to map back to original feature names,</span>
<span class="sd">              - `de_normalize_data(...)` to apply inverse scaling.</span>
<span class="sd">        normalise_weights (dict[int, tuple(float, float)]):</span>
<span class="sd">            Per‑feature (min, max) values for de-scaling.</span>
<span class="sd">        offset (float):</span>
<span class="sd">            Raw offset to subtract (via `de_scale(offset, normalise_weights[0])`)</span>
<span class="sd">            when comparing ages.</span>
<span class="sd">        case (bool or int):</span>
<span class="sd">            If truthy, plot valid vs invalid percentages (unused by default).</span>
<span class="sd">        sample_range (list[int]):</span>
<span class="sd">            List of Monte Carlo sample counts to evaluate (e.g., [1, 2, 3]).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple:</span>
<span class="sd">            - valid_score_arr (list[float]): Percentage of counterfactuals</span>
<span class="sd">              satisfying the age constraint, for each `sample_size`.</span>
<span class="sd">            - invalid_score_arr (list[float]): Percentage violating the</span>
<span class="sd">              age constraint, for each `sample_size`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">invalid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="n">sample_range</span><span class="p">:</span>
        <span class="n">train_x</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">train_dataset</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
        <span class="n">train_y</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">pred_model</span><span class="p">(</span><span class="n">train_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>                
        <span class="n">valid_change</span><span class="o">=</span> <span class="mi">0</span>
        <span class="n">invalid_change</span><span class="o">=</span><span class="mi">0</span> 
        <span class="n">test_size</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">sample_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>
            <span class="n">recon_err</span><span class="p">,</span> <span class="n">kl_err</span><span class="p">,</span> <span class="n">x_true</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_elbo</span><span class="p">(</span> <span class="n">train_x</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">train_y</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span><span class="kc">True</span> <span class="p">)</span>            
            
            <span class="n">x_pred</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>
            <span class="n">x_true</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>                

            <span class="n">age_idx</span> <span class="o">=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> 
                
                <span class="k">if</span> <span class="n">cf_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>                
                <span class="n">test_size</span><span class="o">+=</span><span class="mi">1</span>
                
                <span class="k">if</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">de_scale</span><span class="p">(</span> <span class="n">offset</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]:</span>
                    <span class="n">valid_change</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">invalid_change</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">valid_change</span><span class="o">=</span> <span class="n">valid_change</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">invalid_change</span><span class="o">=</span> <span class="n">invalid_change</span><span class="o">/</span><span class="n">sample_size</span>

        <span class="n">test_size</span><span class="o">=</span> <span class="n">test_size</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">valid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">valid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>
        <span class="n">invalid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">invalid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>

    <span class="n">valid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_score_arr</span><span class="p">))</span>
    <span class="n">invalid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">invalid_score_arr</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;plt.plot(sample_range, valid_score_arr, &#39;*&#39;, label=&#39;Val Age Change&#39;)</span>
<span class="sd">        plt.plot(sample_range, invalid_score_arr, &#39;s&#39;, label=&#39;Inval Age Change&#39;)</span>
<span class="sd">        plt.legend(loc=&#39;upper left&#39;)</span>
<span class="sd">        plt.ylim(ymin=0, ymax=100)</span>
<span class="sd">        plt.title(&#39;Change in Age&#39;)</span>
<span class="sd">        plt.xlabel(&#39;Sample Size&#39;)</span>
<span class="sd">        plt.ylabel(&#39;Percentage of CF&#39;)</span>
<span class="sd">        plt.show()    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean Age Constraint Score: &#39;</span><span class="p">,</span> <span class="n">valid_score</span><span class="p">,</span> <span class="n">invalid_score</span><span class="p">,</span> <span class="n">valid_score</span><span class="o">/</span><span class="p">(</span><span class="n">valid_score</span><span class="o">+</span><span class="n">invalid_score</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">valid_score_arr</span><span class="p">,</span> <span class="n">invalid_score_arr</span></div>


<span class="c1"># ------------------- UNARY CONSTRAINT + LOF ------------------- </span>
<div class="viewcode-block" id="causal_score_age_constraint_lof">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.causal_score_age_constraint_lof">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">causal_score_age_constraint_lof</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">,</span><span class="n">prefix_name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a combined age-education-constraint violation penalty and LOF anomaly score for generated counterfactuals (LOF for feasible cf examples).</span>

<span class="sd">    For each sample in `train_dataset`, this function:</span>
<span class="sd">      1. Generates counterfactuals via the FCX‑VAE `model` conditioned to flip the</span>
<span class="sd">         `pred_model` label.</span>
<span class="sd">      2. Measures any violations of the monotonic age constraint relative to the</span>
<span class="sd">         original age feature (i.e. that age should not decrease).</span>
<span class="sd">      3. Computes a Local Outlier Factor (LOF) anomaly score on the latent encodings.</span>
<span class="sd">      4. Returns a single combined score per sample.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (FCX_VAE): Trained counterfactual VAE.</span>
<span class="sd">        pred_model (BlackBox): Pre-trained classifier used for validity checks.</span>
<span class="sd">        train_dataset (np.ndarray):</span>
<span class="sd">            Original examples with labels, shape `(N, num_features+1)`.</span>
<span class="sd">        d (DataLoader):</span>
<span class="sd">            DataLoader instance providing feature splits and metadata.</span>
<span class="sd">        normalise_weights (dict[int, tuple(float, float)]):</span>
<span class="sd">            Per-feature (min, max) weights for proximity and scaling.</span>
<span class="sd">        offset (int):</span>
<span class="sd">            Index offset indicating how many initial features to treat as immutable</span>
<span class="sd">            (used to locate the age feature).</span>
<span class="sd">        case (int):</span>
<span class="sd">            Metric case identifier (currently unused).</span>
<span class="sd">        sample_range (list[int]):</span>
<span class="sd">            Indices of Monte Carlo samples to generate counterfactuals.</span>
<span class="sd">        prefix_name (str, optional):</span>
<span class="sd">            Prefix for any output logging or filenames (default: `&#39;test&#39;`).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[float]: LOF scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">invalid_score_arr</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="n">sample_range</span><span class="p">:</span>
        <span class="n">train_x</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">train_dataset</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
        <span class="n">train_y</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">pred_model</span><span class="p">(</span><span class="n">train_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>                
        <span class="n">valid_change</span><span class="o">=</span> <span class="mi">0</span>
        <span class="n">invalid_change</span><span class="o">=</span><span class="mi">0</span> 
        <span class="n">test_size</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">full_lof</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">sample_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sample_size</span><span class="p">):</span>
            <span class="n">recon_err</span><span class="p">,</span> <span class="n">kl_err</span><span class="p">,</span> <span class="n">x_true</span><span class="p">,</span> <span class="n">x_pred</span><span class="p">,</span> <span class="n">cf_label</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_elbo</span><span class="p">(</span> <span class="n">train_x</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">train_y</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span><span class="kc">True</span> <span class="p">)</span>            
            <span class="n">x_pred_norm</span> <span class="o">=</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">feas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">x_pred</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_pred</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>
            <span class="n">x_true</span><span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">de_normalize_data</span><span class="p">(</span> <span class="n">d</span><span class="o">.</span><span class="n">get_decoded_data</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span> <span class="p">)</span>                

            <span class="n">age_idx</span> <span class="o">=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">x_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> 
                
                <span class="k">if</span> <span class="n">cf_label</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>                
                <span class="n">test_size</span><span class="o">+=</span><span class="mi">1</span>
                
                <span class="k">if</span> <span class="n">x_pred</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">de_scale</span><span class="p">(</span> <span class="n">offset</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;=</span> <span class="n">x_true</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">age_idx</span><span class="p">]:</span>
                    <span class="n">valid_change</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">invalid_change</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">feas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">feas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">feas</span><span class="p">)</span>
            <span class="n">num_all</span> <span class="o">=</span> <span class="n">feas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">x_pred_norm</span> <span class="o">=</span> <span class="n">x_pred_norm</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="n">x_pred_norm</span> <span class="o">=</span> <span class="n">x_pred_norm</span><span class="p">[</span><span class="n">feas</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">feas</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lof_score_val</span> <span class="o">=</span> <span class="n">lof_score_func</span><span class="p">(</span><span class="n">x_pred_norm</span><span class="p">)</span>
            <span class="c1"># concatenate arrays in the list</span>
            <span class="n">x_pred</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf_label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">x_true</span><span class="p">[</span><span class="s1">&#39;Class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_y</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">x_true</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span><span class="o">+</span><span class="s2">&quot;_x_true.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="n">x_pred</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span><span class="o">+</span><span class="s2">&quot;_x_pred.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span><span class="o">+</span><span class="s2">&quot;_z_pred.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">xprednorm</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x_pred_norm</span><span class="p">)</span>
            <span class="n">xprednorm</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">prefix_name</span><span class="o">+</span><span class="s2">&quot;_x_pred_norm.csv&quot;</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&gt;&gt; Current Average lof score </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lof_score_val</span><span class="p">))</span>
            <span class="c1">#plot with tsne import tsne</span>
            <span class="c1">#lof = LocalOutlierFactor(n_neighbors=6, metric=&#39;euclidean&#39;)</span>
            <span class="c1">#lof_scores= lof.fit_predict(x_pred_norm) # tha mporouse kai gia x_true na ypologistei</span>

<span class="w">            </span><span class="sd">&quot;&quot;&quot;from sklearn.manifold import TSNE</span>
<span class="sd">            tsne = TSNE(n_components=2, random_state=0)</span>
<span class="sd">            x_pred_norm_tsne = tsne.fit_transform(x_pred_norm)</span>
<span class="sd">            plt.scatter(x_pred_norm_tsne[:,0], x_pred_norm_tsne[:,1],c=lof_scores)</span>
<span class="sd">            plt.title(&#39;TSNE&#39;)</span>
<span class="sd">            plt.show()</span>

<span class="sd">            # calculate lof score</span>
<span class="sd">            k_lof_results=[]</span>
<span class="sd">            for k in range(3,500,3):</span>
<span class="sd">                lof = LocalOutlierFactor(n_neighbors=k, metric=&#39;euclidean&#39;)</span>
<span class="sd">                #lof.fit(x_pred2.drop(columns=[&#39;Class&#39;]))</span>
<span class="sd">                lof_scores= lof.fit_predict(x_pred_norm) # tha mporouse kai gia x_true na ypologistei</span>
<span class="sd">                #lof_scores = -lof.negative_outlier_factor_</span>
<span class="sd">                temp_lof_score = np.sum(lof_scores==-1)</span>
<span class="sd">                #lof_score_per_iter+=temp_lof_score</span>
<span class="sd">                k_lof_results.append(temp_lof_score)</span>
<span class="sd">            </span>
<span class="sd">            k_range = [*range(3,500,3)]</span>
<span class="sd">            print(&quot;k_lof_results&quot;, k_lof_results)</span>
<span class="sd">            #print(np.argmax(k_lof_results[0:100]))</span>
<span class="sd">            plt.plot(k_range, k_lof_results)</span>
<span class="sd">            plt.title(&#39;LOF CF&#39;)</span>
<span class="sd">            plt.xlabel(&#39;k&#39;)</span>
<span class="sd">            plt.ylabel(&#39;LOF&#39;)</span>
<span class="sd">            plt.show()&quot;&quot;&quot;</span>

            <span class="n">full_lof</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lof_score_val</span><span class="p">)</span>
        <span class="n">valid_change</span><span class="o">=</span> <span class="n">valid_change</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">invalid_change</span><span class="o">=</span> <span class="n">invalid_change</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">test_size</span><span class="o">=</span> <span class="n">test_size</span><span class="o">/</span><span class="n">sample_size</span>
        <span class="n">valid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">valid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>
        <span class="n">invalid_score_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">invalid_change</span><span class="o">/</span><span class="n">test_size</span> <span class="p">)</span>

    <span class="n">valid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_score_arr</span><span class="p">))</span>
    <span class="n">invalid_score</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">invalid_score_arr</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;plt.plot(sample_range, valid_score_arr, &#39;*&#39;, label=&#39;Val Age Change&#39;)</span>
<span class="sd">        plt.plot(sample_range, invalid_score_arr, &#39;s&#39;, label=&#39;Inval Age Change&#39;)</span>
<span class="sd">        plt.legend(loc=&#39;upper left&#39;)</span>
<span class="sd">        plt.ylim(ymin=0, ymax=100)</span>
<span class="sd">        plt.title(&#39;Change in Age&#39;)</span>
<span class="sd">        plt.xlabel(&#39;Sample Size&#39;)</span>
<span class="sd">        plt.ylabel(&#39;Percentage of CF&#39;)</span>
<span class="sd">        plt.show()  &quot;&quot;&quot;</span>  
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final average lof score&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">full_lof</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">full_lof</span></div>


<span class="c1"># ------------------- MAIN FUNCTION FOR EVALUATION: CALLS THE FUNCTIONS FOR THE METRICS ------------------- </span>
<div class="viewcode-block" id="compute_eval_metrics_adult">
<a class="viewcode-back" href="../../../../../fcx_evaluate_unary_adult.html#humancompatible.explain.fcx.scripts.evaluation_functions_adult.compute_eval_metrics_adult">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_eval_metrics_adult</span><span class="p">(</span><span class="n">immutables</span><span class="p">,</span> <span class="n">methods</span><span class="p">,</span> <span class="n">base_model_dir</span><span class="p">,</span> <span class="n">encoded_size</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">mad_feature_weights</span><span class="p">,</span> <span class="n">div_case</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span><span class="n">prefix_name</span><span class="o">=</span><span class="s1">&#39;samples&#39;</span> <span class="p">):</span>   
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute a specified evaluation metric for each trained FCX-VAE model on the Adult dataset.</span>

<span class="sd">    For each entry in `methods`, this function:</span>
<span class="sd">      1. Loads the corresponding VAE checkpoint.</span>
<span class="sd">      2. Samples counterfactuals on the held-out validation set.</span>
<span class="sd">      3. Computes a single metric given by `case`:</span>
<span class="sd">         - 0: validity (fraction of CFs that flip the classifier)</span>
<span class="sd">         - 1: feasibility (constraint score)</span>
<span class="sd">         - 2: continuous proximity</span>
<span class="sd">         - 3: categorical proximity</span>
<span class="sd">         - 4: LOF anomaly score</span>
<span class="sd">      4. Stores the result in a dictionary under the method’s key.</span>

<span class="sd">    Args:</span>
<span class="sd">        immutables (bool):</span>
<span class="sd">            If True, treats the last 4 features as immutable during CF generation.</span>
<span class="sd">        methods (dict[str, str]):</span>
<span class="sd">            Mapping from method name to VAE checkpoint filepath.</span>
<span class="sd">        base_model_dir (str):</span>
<span class="sd">            Directory where model checkpoints are stored.</span>
<span class="sd">        encoded_size (int):</span>
<span class="sd">            Latent dimensionality of the FCX‑VAE.</span>
<span class="sd">        pred_model (BlackBox):</span>
<span class="sd">            Pre-trained black-box classifier for validity checking.</span>
<span class="sd">        val_dataset (np.ndarray):</span>
<span class="sd">            Validation data array including labels, shape (N, d+1).</span>
<span class="sd">        d (DataLoader):</span>
<span class="sd">            DataLoader instance providing feature encodings and metadata.</span>
<span class="sd">        normalise_weights (dict[int, tuple[float, float]]):</span>
<span class="sd">            Per-feature (min, max) weights for proximity calculations.</span>
<span class="sd">        mad_feature_weights (dict[int, Any]):</span>
<span class="sd">            Feature weights used for LOF anomaly scoring.</span>
<span class="sd">        div_case (int):</span>
<span class="sd">            Diversity case identifier (unused in basic metrics).</span>
<span class="sd">        case (int):</span>
<span class="sd">            Metric case index to compute:</span>
<span class="sd">              0=validity, 1=feasibility, 2=cont-prox, 3=cat‑prox, 4=LOF.</span>
<span class="sd">        sample_range (list[int]):</span>
<span class="sd">            Indices of Monte Carlo samples to evaluate.</span>
<span class="sd">        filename (str):</span>
<span class="sd">            Base name for saving any output plots or arrays.</span>
<span class="sd">        prefix_name (str, optional):</span>
<span class="sd">            Prefix for naming sample output files (default: &#39;samples&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            Mapping each method name to its computed metric value (float).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">fsize</span><span class="o">=</span><span class="mi">20</span>
    <span class="c1">#fig = plt.figure(figsize=(7.7,6.5))</span>
    <span class="n">final_res</span><span class="o">=</span> <span class="p">{}</span>
    <span class="n">dataset_name</span><span class="o">=</span> <span class="s1">&#39;adult&#39;</span>
    
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">)</span>
    <span class="n">x_sample</span><span class="o">=</span> <span class="n">val_dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>    
    <span class="n">x_sample</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">x_sample</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">val_dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;adult-visualise-sample.npy&#39;</span><span class="p">,</span> <span class="n">x_sample</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">methods</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="c1">#Loading torch model</span>
        <span class="n">wm1</span><span class="o">=</span><span class="mf">1e-2</span>
        <span class="n">wm2</span><span class="o">=</span><span class="mf">1e-2</span>
        <span class="n">wm3</span><span class="o">=</span><span class="mf">1e-2</span>
        <span class="n">wm4</span><span class="o">=</span><span class="mf">1e-2</span>

        <span class="n">path</span><span class="o">=</span> <span class="n">methods</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">cf_val</span><span class="o">=</span><span class="p">[]</span>
            
        <span class="k">if</span> <span class="n">immutables</span><span class="p">:</span>
            <span class="n">fcx_vae</span> <span class="o">=</span> <span class="n">FCX_VAE</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">encoded_feature_names</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">encoded_size</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fcx_vae</span> <span class="o">=</span> <span class="n">FCX_VAE</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">encoded_feature_names</span><span class="p">),</span> <span class="n">encoded_size</span><span class="p">,</span> <span class="n">d</span> <span class="p">)</span>

        <span class="n">fcx_vae</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">fcx_vae</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">1e-2</span>
        <span class="n">fcx_vae_optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">([</span>
            <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">fcx_vae</span><span class="o">.</span><span class="n">encoder_mean</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">wm1</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">fcx_vae</span><span class="o">.</span><span class="n">encoder_var</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">wm2</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">,</span> <span class="n">fcx_vae</span><span class="o">.</span><span class="n">decoder_mean</span><span class="o">.</span><span class="n">parameters</span><span class="p">()),</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="n">wm3</span><span class="p">}</span>
        <span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>        


        <span class="c1"># Put the check for only Low to High Income CF</span>
        <span class="n">train_x</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span> <span class="n">val_dataset</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> 
        <span class="n">train_y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">pred_model</span><span class="p">(</span><span class="n">train_x</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">val_dataset</span><span class="o">=</span> <span class="n">val_dataset</span><span class="p">[</span> <span class="n">train_y</span><span class="o">==</span><span class="mi">0</span> <span class="p">]</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">case</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">cf_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">validity_score</span><span class="p">(</span><span class="n">fcx_vae</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">val</span><span class="p">,</span> <span class="n">inval</span><span class="o">=</span> <span class="n">causal_score_age_constraint</span><span class="p">(</span><span class="n">fcx_vae</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">)</span>
                <span class="n">cf_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inval</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">val</span><span class="p">,</span> <span class="n">inval</span><span class="o">=</span> <span class="n">causal_score_age_ed_constraint</span><span class="p">(</span><span class="n">fcx_vae</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">)</span>
                <span class="n">cf_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inval</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">cf_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">proximity_score</span><span class="p">(</span><span class="n">fcx_vae</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">mad_feature_weights</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">cf_val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">proximity_score</span><span class="p">(</span><span class="n">fcx_vae</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">mad_feature_weights</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span>
                <span class="c1"># Future work</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>
                <span class="c1"># Future work</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>
                <span class="n">cf_val</span><span class="o">=</span> <span class="n">causal_score_age_ed_constraint_lof</span><span class="p">(</span><span class="n">fcx_vae</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">,</span><span class="n">prefix_name</span><span class="o">=</span><span class="n">prefix_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">case</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
                <span class="n">cf_val</span><span class="o">=</span> <span class="n">causal_score_age_constraint_lof</span><span class="p">(</span><span class="n">fcx_vae</span><span class="p">,</span> <span class="n">pred_model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">normalise_weights</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sample_range</span><span class="p">,</span><span class="n">prefix_name</span><span class="o">=</span><span class="n">prefix_name</span><span class="p">)</span>

        <span class="n">final_res</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span> <span class="n">cf_val</span>
        <span class="n">cf_val</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cf_val</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">case</span><span class="o">==</span><span class="mi">7</span> <span class="ow">or</span> <span class="n">case</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>
            <span class="n">cf_val</span><span class="o">=</span><span class="p">[</span><span class="n">cf_val</span><span class="p">]</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;if case==0:</span>
<span class="sd">            plt.title(&#39;Target Class Valid CF&#39;, fontsize=fsize)</span>
<span class="sd">            plt.xlabel(&#39;Total Counterfactuals requested per data point&#39;, fontsize=fsize)</span>
<span class="sd">            plt.ylabel(&#39;Percentage of valid CF w.r.t. ML Classifier&#39;,  fontsize=fsize)</span>
<span class="sd">        elif case==1:</span>
<span class="sd">            plt.title(&#39;Constraint Valid CF: Age Constraint&#39;, fontsize=fsize)</span>
<span class="sd">            plt.xlabel(&#39;Total counterfactuals requested per data point&#39;, fontsize=fsize)</span>
<span class="sd">            plt.ylabel(&#39;Percentage of CF satisfying Constraint&#39;, fontsize=fsize)</span>
<span class="sd">        elif case==2:</span>
<span class="sd">            plt.title(&#39;Constraint Valid CF: Age-Education Constraint&#39;, fontsize=fsize)</span>
<span class="sd">            plt.xlabel(&#39;Total counterfactuals requested per data point&#39;, fontsize=fsize)</span>
<span class="sd">            plt.ylabel(&#39;Percentage of CF satisfying Constraint&#39;, fontsize=fsize)</span>
<span class="sd">        elif case==3:</span>
<span class="sd">            plt.title(&#39;Continuous Proximity Score&#39;, fontsize=fsize)</span>
<span class="sd">            plt.xlabel(&#39;Total counterfactuals requested per data point&#39;, fontsize=fsize)</span>
<span class="sd">            plt.ylabel(&#39;Total change in continuous features&#39;, fontsize=fsize)</span>
<span class="sd">        elif case==4:</span>
<span class="sd">            plt.title(&#39;Categorical Proximity Score&#39;, fontsize=fsize)</span>
<span class="sd">            plt.xlabel(&#39;Total counterfactuals requested per data point&#39;, fontsize=fsize)</span>
<span class="sd">            plt.ylabel(&#39;Total change in categorical features&#39;, fontsize=fsize)</span>
<span class="sd">        elif case==6:</span>
<span class="sd">            pass</span>
<span class="sd">        elif case==7 or case==8:</span>
<span class="sd">            plt.title(&#39;LOF&#39;, fontsize=fsize)</span>
<span class="sd">            plt.xlabel(&#39;Total counterfactuals requested per data point&#39;, fontsize=fsize)</span>
<span class="sd">            plt.ylabel(&#39;Total lof&#39;, fontsize=fsize)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">count</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cf_val</span><span class="p">)</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cf_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">low</span><span class="o">&gt;</span><span class="nb">min</span><span class="p">(</span><span class="n">cf_val</span><span class="p">):</span>
                <span class="n">low</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">cf_val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">high</span><span class="o">&lt;</span><span class="nb">max</span><span class="p">(</span><span class="n">cf_val</span><span class="p">):</span>
                <span class="n">high</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">cf_val</span><span class="p">)</span>
<span class="w">                </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;if case ==0 or case ==1 or case ==2:</span>
<span class="sd">            plt.ylim(0,101)</span>
<span class="sd">        elif case ==3 or case ==4:</span>
<span class="sd">            plt.ylim([np.ceil(low-0.5*np.abs(high)), np.ceil(high+0.5*np.abs(high))])</span>
<span class="sd">        else:</span>
<span class="sd">            plt.ylim([np.ceil(low-0.5-0.5*(high-low)), np.ceil(high+0.5+0.5*(high-low))])  &quot;&quot;&quot;</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;if len(sample_range)==1:</span>
<span class="sd">            plt.plot(sample_range, cf_val, &#39;.&#39;, label=key)</span>
<span class="sd">        else:</span>
<span class="sd">            plt.plot(sample_range, cf_val, label=key)  &quot;&quot;&quot;</span>          
            
        <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>    
    
    <span class="c1">#plt.legend(loc=&#39;lower left&#39;, fontsize=fsize/1.3)    </span>

    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;results/adult&#39;</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#plt.savefig(&#39;results/adult/&#39;+filename+&#39;.jpg&#39;)</span>
    <span class="c1">#plt.show()</span>
    <span class="k">return</span> <span class="n">final_res</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, AutoFair Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>