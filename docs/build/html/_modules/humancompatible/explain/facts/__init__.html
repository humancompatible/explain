

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>humancompatible.explain.facts.__init__ &mdash; HumanCompatible.Explain  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            HumanCompatible.Explain
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../facts.html">FACTS: Fairness Aware Counterfactual for Subgrouos package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glance.html">GLANCE: Global Actions in a Nutshell for Counterfactual Explainability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../fcx.html">FCX: Finding Feasible Counterfactual Explanation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">HumanCompatible.Explain</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">humancompatible.explain.facts.__init__</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for humancompatible.explain.facts.__init__</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEstimator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParameterProxy</span><span class="p">,</span> <span class="n">feature_change_builder</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.misc</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">valid_ifthens</span><span class="p">,</span>
        <span class="n">calc_costs</span><span class="p">,</span>
        <span class="n">rules2rulesbyif</span><span class="p">,</span>
        <span class="n">select_rules_subset</span><span class="p">,</span>
        <span class="n">select_rules_subset_KStest</span><span class="p">,</span>
        <span class="n">cum_corr_costs_all</span>
    <span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.formatting</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_recourse_report</span><span class="p">,</span> <span class="n">print_recourse_report_KStest_cumulative</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.rule_filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">delete_fair_rules</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">warning</span>
    <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: FACTS will be unavailable. To install, run:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;pip install &#39;aif360[FACTS]&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
    <span class="n">print_recourse_report</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FACTS&quot;</span><span class="p">,</span> <span class="s2">&quot;print_recourse_report&quot;</span><span class="p">,</span> <span class="s2">&quot;FACTS_bias_scan&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="FACTS_bias_scan">
<a class="viewcode-back" href="../../../../facts.html#humancompatible.explain.facts.__init__.FACTS_bias_scan">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">FACTS_bias_scan</span><span class="p">(</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">clf</span><span class="p">:</span> <span class="n">BaseEstimator</span><span class="p">,</span>
    <span class="n">prot_attr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">categorical_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">freq_itemset_min_supp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">feature_weights</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">feats_allowed_to_change</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">feats_not_allowed_to_change</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">viewpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span>
    <span class="n">sort_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;max-cost-diff-decr&quot;</span><span class="p">,</span>
    <span class="n">top_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">print_recourse_report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">show_subgroup_costs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">show_action_costs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">is_correctness_metric</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify the subgroups with the most difficulty achieving recourse.</span>

<span class="sd">    FACTS is an efficient, model-agnostic, highly parameterizable, and</span>
<span class="sd">    explainable framework for evaluating subgroup fairness through</span>
<span class="sd">    counterfactual explanations [#FACTS23]_.</span>

<span class="sd">    Note:</span>
<span class="sd">        This function is a wrapper to run the FACTS framework from start to</span>
<span class="sd">        finish. Its purpose is to provide an API which is both closer to the</span>
<span class="sd">        `detectors` API and more succinct.</span>

<span class="sd">        For more options and greater control (including the option to cache</span>
<span class="sd">        some intermediate results and then apply more than one metric fast),</span>
<span class="sd">        consider using the :class:`FACTS` class.</span>

<span class="sd">    References:</span>
<span class="sd">        .. [#FACTS23] `L. Kavouras, K. Tsopelas, G. Giannopoulos,</span>
<span class="sd">           D. Sacharidis, E. Psaroudaki, N. Theologitis, D. Rontogiannis,</span>
<span class="sd">           D. Fotakis, I. Emiris, &quot;Fairness Aware Counterfactuals for</span>
<span class="sd">           Subgroups&quot;, arXiv preprint, 2023.</span>
<span class="sd">           &lt;https://arxiv.org/abs/2306.14978&gt;`_</span>

<span class="sd">    Args:</span>
<span class="sd">        X (DataFrame): Dataset given as a :class:`pandas.DataFrame`. As in</span>
<span class="sd">            standard scikit-learn convention, it is expected to contain one</span>
<span class="sd">            instance per row and one feature / explanatory variable per</span>
<span class="sd">            column (labels not needed, we already have an ML model).</span>

<span class="sd">        clf (sklearn.base.BaseEstimator): A trained and ready to use</span>
<span class="sd">            classifier, implementing method `predict(X)`, where `X` is</span>
<span class="sd">            the matrix of features; predictions returned by `predict(X)`</span>
<span class="sd">            are either 0 or 1. In other words, fitted scikit-learn</span>
<span class="sd">            classifiers.</span>

<span class="sd">        prot_attr (str): the name of the column that represents the</span>
<span class="sd">            protected attribute.</span>

<span class="sd">        metric (str, optional): one of the following choices</span>

<span class="sd">            - &quot;equal-effectiveness&quot;</span>
<span class="sd">            - &quot;equal-choice-for-recourse&quot;</span>
<span class="sd">            - &quot;equal-effectiveness-within-budget&quot;</span>
<span class="sd">            - &quot;equal-cost-of-effectiveness&quot;</span>
<span class="sd">            - &quot;equal-mean-recourse&quot;</span>
<span class="sd">            - &quot;fair-tradeoff&quot;</span>

<span class="sd">            Defaults to &quot;equal-effectiveness&quot;.</span>

<span class="sd">            For explanation of each of those metrics, refer either to the</span>
<span class="sd">            paper [#FACTS23]_ or the demo_FACTS notebook.</span>

<span class="sd">        categorical_features (list(str), optional): the list of categorical</span>
<span class="sd">            features. The default is to choose (dynamically, inside `fit`) the</span>
<span class="sd">            columns of the dataset with types &quot;object&quot; or &quot;category&quot;.</span>

<span class="sd">        freq_itemset_min_supp (float, optional): minimum support for all the runs</span>
<span class="sd">            of the frequent itemset mining algorithm (specifically, `FP Growth &lt;https://en.wikipedia.org/wiki/Association_rule_learning#FP-growth_algorithm&gt;`_).</span>
<span class="sd">            We mine frequent itemsets to generate candidate subpopulation groups and candidate actions.</span>
<span class="sd">            For more information, see paper [#FACTS23]_.</span>
<span class="sd">            Defaults to 10%.</span>

<span class="sd">        feature_weights (dict(str, float), optional): the weights for each feature. Used in the calculation</span>
<span class="sd">            of the cost of a suggested change. Specifically, the term corresponding to each feature is</span>
<span class="sd">            multiplied by this weight.</span>
<span class="sd">            Defaults to 1, for all features.</span>

<span class="sd">        feats_allowed_to_change (list(str), optional): if provided, only</span>
<span class="sd">            allows these features to change value in the suggested recourses.</span>
<span class="sd">            Default: no frozen features.</span>
<span class="sd">            *Note*: providing both `feats_allowed_to_change` and</span>
<span class="sd">            `feats_not_allowed_to_change` is currently treated as an error.</span>

<span class="sd">        feats_not_allowed_to_change (list(str), optional): if provided,</span>
<span class="sd">            prevents these features from changing at all in any given</span>
<span class="sd">            recourse.</span>
<span class="sd">            Default: no frozen features.</span>
<span class="sd">            *Note*: providing both `feats_allowed_to_change` and</span>
<span class="sd">            `feats_not_allowed_to_change` is currently treated as an error.</span>

<span class="sd">        viewpoint (str, optional): &quot;macro&quot; or &quot;micro&quot;. Refers to the</span>
<span class="sd">            notions of &quot;macro viewpoint&quot; and &quot;micro viewpoint&quot; defined</span>
<span class="sd">            in section 2.2 of the paper [#FACTS23]_.</span>

<span class="sd">            As a short explanation, consider a set of actions A and a</span>
<span class="sd">            subgroup (cohort / set of individuals) G. Metrics with the</span>
<span class="sd">            macro viewpoint interpretation are constrained to always apply</span>
<span class="sd">            one action from A to the entire G, while metrics with the micro</span>
<span class="sd">            interpretation are allowed to give each individual in G the</span>
<span class="sd">            min-cost action from A which changes the individual&#39;s class.</span>

<span class="sd">            Note that not all combinations of `metric` and `viewpoint` are</span>
<span class="sd">            valid, e.g. &quot;Equal Choice for Recourse&quot; only has a macro</span>
<span class="sd">            interpretation.</span>

<span class="sd">            Defaults to &quot;macro&quot;.</span>

<span class="sd">        sort_strategy (str, optional): one of the following choices</span>

<span class="sd">            - `&quot;max-cost-diff-decr&quot;`: simply rank the groups in descending \</span>
<span class="sd">                order according to the unfairness metric.</span>
<span class="sd">            - `&quot;max-cost-diff-decr-ignore-forall-subgroups-empty&quot;`: ignore \</span>
<span class="sd">                groups for which we have no available actions whatsoever.</span>
<span class="sd">            - `&quot;max-cost-diff-decr-ignore-exists-subgroup-empty&quot;`: ignore \</span>
<span class="sd">                groups for which at least one protected subgroup has \</span>
<span class="sd">                no available actions.</span>

<span class="sd">            Defaults to &quot;max-cost-diff-decr&quot;.</span>

<span class="sd">        top_count (int, optional): the number of subpopulation groups that</span>
<span class="sd">            the algorithm will keep.</span>
<span class="sd">            Defaults to 1, i.e. returns the most biased group.</span>

<span class="sd">        phi (float, optional): effectiveness threshold. Real number in [0, 1].</span>
<span class="sd">            Applicable for &quot;equal-choice-for-recourse&quot; and</span>
<span class="sd">            &quot;equal-cost-of-effectiveness&quot; metrics. For these two metrics, an</span>
<span class="sd">            action is considered to achieve recourse for a subpopulation group</span>
<span class="sd">            if at least `phi` % of the group&#39;s individuals achieve recourse.</span>
<span class="sd">            Defaults to 0.5.</span>

<span class="sd">        c (float, optional): cost budget. Real number. Applicable for</span>
<span class="sd">            &quot;equal-effectiveness-within-budget&quot; metric. Specifies the maximum</span>
<span class="sd">            cost that can be payed for an action (by the individual, by a</span>
<span class="sd">            central authority etc.)</span>
<span class="sd">            Defaults to 0.5.</span>

<span class="sd">        verbose (bool, optional): whether to print intermediate messages and</span>
<span class="sd">            progress bar. Defaults to True.</span>

<span class="sd">        print_recourse_report (bool, optional): whether to print a detailed</span>
<span class="sd">            and annotated report of the most biased groups to stdout. If False,</span>
<span class="sd">            the most biased groups are only computed and returned.</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">        show_subgroup_costs (bool, optional): Whether to show the costs assigned</span>
<span class="sd">            to each protected subgroup.</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">        show_action_costs (bool, optional): Whether to show the costs assigned</span>
<span class="sd">            to each specific action.</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">        is_correctness_metric (bool, optional): if True, the metric is considered</span>
<span class="sd">            to quantify utility, i.e. the greater it is for a group, the</span>
<span class="sd">            more beneficial it is for the individuals of the group.</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list(tuple(dict(str, str), float)): the most biased groups as a list \</span>
<span class="sd">            of pairs. In each pair, the first element is the group description \</span>
<span class="sd">            as a dict. The second element is the value of the chosen unfairness \</span>
<span class="sd">            metric for this group.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">detector</span> <span class="o">=</span> <span class="n">FACTS</span><span class="p">(</span>
        <span class="n">clf</span><span class="o">=</span><span class="n">clf</span><span class="p">,</span>
        <span class="n">prot_attr</span><span class="o">=</span><span class="n">prot_attr</span><span class="p">,</span>
        <span class="n">categorical_features</span><span class="o">=</span><span class="n">categorical_features</span><span class="p">,</span>
        <span class="n">freq_itemset_min_supp</span><span class="o">=</span><span class="n">freq_itemset_min_supp</span><span class="p">,</span>
        <span class="n">feature_weights</span><span class="o">=</span><span class="n">feature_weights</span><span class="p">,</span> <span class="c1"># type: ignore</span>
        <span class="n">feats_allowed_to_change</span><span class="o">=</span><span class="n">feats_allowed_to_change</span><span class="p">,</span>
        <span class="n">feats_not_allowed_to_change</span><span class="o">=</span><span class="n">feats_not_allowed_to_change</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">detector</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">detector</span><span class="o">.</span><span class="n">bias_scan</span><span class="p">(</span>
        <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
        <span class="n">viewpoint</span><span class="o">=</span><span class="n">viewpoint</span><span class="p">,</span>
        <span class="n">sort_strategy</span><span class="o">=</span><span class="n">sort_strategy</span><span class="p">,</span>
        <span class="n">top_count</span><span class="o">=</span><span class="n">top_count</span><span class="p">,</span>
        <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
        <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">print_recourse_report</span><span class="p">:</span>
        <span class="n">detector</span><span class="o">.</span><span class="n">print_recourse_report</span><span class="p">(</span>
            <span class="n">show_subgroup_costs</span><span class="o">=</span><span class="n">show_subgroup_costs</span><span class="p">,</span>
            <span class="n">show_action_costs</span><span class="o">=</span><span class="n">show_action_costs</span><span class="p">,</span>
            <span class="n">correctness_metric</span><span class="o">=</span><span class="n">is_correctness_metric</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">detector</span><span class="o">.</span><span class="n">subgroup_costs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">detector</span><span class="o">.</span><span class="n">unfairness</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">unfairness</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">sg</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">costs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">costs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">sg</span><span class="p">,</span> <span class="n">costs</span> <span class="ow">in</span> <span class="n">detector</span><span class="o">.</span><span class="n">subgroup_costs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">most_biased_subgroups</span> <span class="o">=</span> <span class="p">[(</span><span class="n">sg</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="n">sg</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">sg</span> <span class="ow">in</span> <span class="n">detector</span><span class="o">.</span><span class="n">top_rules</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">most_biased_subgroups</span></div>


<div class="viewcode-block" id="FACTS">
<a class="viewcode-back" href="../../../../facts.html#humancompatible.explain.facts.__init__.FACTS">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FACTS</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fairness aware counterfactuals for subgroups (FACTS) detector.</span>

<span class="sd">    FACTS is an efficient, model-agnostic, highly parameterizable, and</span>
<span class="sd">    explainable framework for evaluating subgroup fairness through</span>
<span class="sd">    counterfactual explanations [#FACTS23]_.</span>

<span class="sd">    This class is a wrapper for the various methods exposed by the</span>
<span class="sd">    FACTS framework.</span>

<span class="sd">    References:</span>
<span class="sd">        .. [#FACTS23] `L. Kavouras, K. Tsopelas, G. Giannopoulos,</span>
<span class="sd">           D. Sacharidis, E. Psaroudaki, N. Theologitis, D. Rontogiannis,</span>
<span class="sd">           D. Fotakis, I. Emiris, &quot;Fairness Aware Counterfactuals for</span>
<span class="sd">           Subgroups&quot;, arXiv preprint, 2023.</span>
<span class="sd">           &lt;https://arxiv.org/abs/2306.14978&gt;`_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">clf</span><span class="p">,</span>
        <span class="n">prot_attr</span><span class="p">,</span>
        <span class="n">categorical_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">freq_itemset_min_supp</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">feature_weights</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span> <span class="p">:</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">feats_allowed_to_change</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feats_not_allowed_to_change</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            clf (sklearn.base.BaseEstimator): A trained and ready to use</span>
<span class="sd">                classifier, implementing method `predict(X)`, where `X` is</span>
<span class="sd">                the matrix of features; predictions returned by `predict(X)`</span>
<span class="sd">                are either 0 or 1. In other words, fitted scikit-learn</span>
<span class="sd">                classifiers.</span>
<span class="sd">            prot_attr (str): the name of the column that represents the</span>
<span class="sd">                protected attribute.</span>
<span class="sd">            categorical_features (list(str), optional): the list of categorical</span>
<span class="sd">                features. The default is to choose (dynamically, inside `fit`) the</span>
<span class="sd">                columns of the dataset with types &quot;object&quot; or &quot;category&quot;.</span>
<span class="sd">            freq_itemset_min_supp (float, optional): minimum support for all the runs</span>
<span class="sd">                of the frequent itemset mining algorithm (specifically, `FP Growth &lt;https://en.wikipedia.org/wiki/Association_rule_learning#FP-growth_algorithm&gt;`_).</span>
<span class="sd">                We mine frequent itemsets to generate candidate subpopulation groups and candidate actions.</span>
<span class="sd">                For more information, see paper [#FACTS23]_.</span>
<span class="sd">                Defaults to 10%.</span>
<span class="sd">            feature_weights (dict(str, float), optional): the weights for each feature. Used in the calculation</span>
<span class="sd">                of the cost of a suggested change. Specifically, the term corresponding to each feature is</span>
<span class="sd">                multiplied by this weight.</span>
<span class="sd">                Defaults to 1, for all features.</span>
<span class="sd">            feats_allowed_to_change (list(str), optional): if provided, only</span>
<span class="sd">                allows these features to change value in the suggested recourses.</span>
<span class="sd">                Default: no frozen features.</span>
<span class="sd">                *Note*: providing both `feats_allowed_to_change` and</span>
<span class="sd">                `feats_not_allowed_to_change` is currently treated as an error.</span>
<span class="sd">            feats_not_allowed_to_change (list(str), optional): if provided,</span>
<span class="sd">                prevents these features from changing at all in any given</span>
<span class="sd">                recourse.</span>
<span class="sd">                Default: no frozen features.</span>
<span class="sd">                *Note*: providing both `feats_allowed_to_change` and</span>
<span class="sd">                `feats_not_allowed_to_change` is currently treated as an error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clf</span> <span class="o">=</span> <span class="n">clf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prot_attr</span> <span class="o">=</span> <span class="n">prot_attr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_itemset_min_supp</span> <span class="o">=</span> <span class="n">freq_itemset_min_supp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span> <span class="o">=</span> <span class="n">categorical_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_weights</span> <span class="o">=</span> <span class="n">feature_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feats_allowed_to_change</span> <span class="o">=</span> <span class="n">feats_allowed_to_change</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feats_not_allowed_to_change</span> <span class="o">=</span> <span class="n">feats_not_allowed_to_change</span>

<div class="viewcode-block" id="FACTS.fit">
<a class="viewcode-back" href="../../../../facts.html#humancompatible.explain.facts.__init__.FACTS.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates subpopulation groups, actions and respective effectiveness</span>

<span class="sd">        Args:</span>
<span class="sd">            X (DataFrame): Dataset given as a :class:`pandas.DataFrame`. As in</span>
<span class="sd">                standard scikit-learn convention, it is expected to contain one</span>
<span class="sd">                instance per row and one feature / explanatory variable per</span>
<span class="sd">                column (labels not needed, we already have an ML model).</span>
<span class="sd">            verbose (bool): whether to print intermediate messages and progress bar. Defaults to True.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: `feats_allowed_to_change` and `feats_not_allowed_to_change`</span>
<span class="sd">                cannot be given simultaneously.</span>
<span class="sd">            Exception: when unreachable code is executed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            FACTS: Returns self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">all_feats</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feats_allowed_to_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feats_not_allowed_to_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please specify only feats_allowed_to_change or feats_not_allowed_to_change, not both.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feats_allowed_to_change</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">feats_not_allowed_to_change</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feats_not_allowed_to_change</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feats_allowed_to_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feats_not_allowed_to_change</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">all_feats</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feats_allowed_to_change</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">feats_not_allowed_to_change</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feats_not_allowed_to_change</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feats_not_allowed_to_change</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Code should be unreachable.&quot;</span><span class="p">)</span>

        <span class="n">num_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="p">))</span>
        <span class="n">comparators</span> <span class="o">=</span> <span class="n">feature_change_builder</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">num_cols</span><span class="o">=</span><span class="n">num_features</span><span class="p">,</span>
            <span class="n">cate_cols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">categorical_features</span><span class="p">,</span>
            <span class="n">ord_cols</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">feature_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_weights</span><span class="p">,</span>
            <span class="n">num_normalization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">ParameterProxy</span><span class="p">(</span><span class="n">featureChanges</span><span class="o">=</span><span class="n">comparators</span><span class="p">)</span>

        <span class="n">ifthens_coverage_correctness</span> <span class="o">=</span> <span class="n">valid_ifthens</span><span class="p">(</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">,</span>
            <span class="n">sensitive_attribute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prot_attr</span><span class="p">,</span>
            <span class="n">freqitem_minsupp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_itemset_min_supp</span><span class="p">,</span>
            <span class="n">drop_infeasible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">feats_not_allowed_to_change</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">feats_not_allowed_to_change</span><span class="p">),</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">rules_by_if</span> <span class="o">=</span> <span class="n">rules2rulesbyif</span><span class="p">(</span><span class="n">ifthens_coverage_correctness</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing percentages of individuals flipped by any action with cost up to c, for every c&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules_with_cumulative</span> <span class="o">=</span> <span class="n">cum_corr_costs_all</span><span class="p">(</span>
            <span class="n">rulesbyif</span><span class="o">=</span><span class="n">rules_by_if</span><span class="p">,</span>
            <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="p">,</span>
            <span class="n">sensitive_attribute</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prot_attr</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules_by_if</span> <span class="o">=</span> <span class="n">calc_costs</span><span class="p">(</span><span class="n">rules_by_if</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="FACTS.bias_scan">
<a class="viewcode-back" href="../../../../facts.html#humancompatible.explain.facts.__init__.FACTS.bias_scan">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bias_scan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equal-effectiveness&quot;</span><span class="p">,</span>
        <span class="n">viewpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;macro&quot;</span><span class="p">,</span>
        <span class="n">sort_strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;max-cost-diff-decr&quot;</span><span class="p">,</span>
        <span class="n">top_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">filter_sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">c</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Examines generated subgroups and calculates the `top_count` most</span>
<span class="sd">        unfair ones, with respect to the chosen metric.</span>

<span class="sd">        Stores the final groups in instance variable `self.top_rules` and the</span>
<span class="sd">        respective subgroup costs in `self.subgroup_costs` (or `self.unfairness`</span>
<span class="sd">        for the &quot;fair-tradeoff&quot; metric).</span>

<span class="sd">        Args:</span>
<span class="sd">            metric (str, optional): one of the following choices</span>

<span class="sd">                - &quot;equal-effectiveness&quot;</span>
<span class="sd">                - &quot;equal-choice-for-recourse&quot;</span>
<span class="sd">                - &quot;equal-effectiveness-within-budget&quot;</span>
<span class="sd">                - &quot;equal-cost-of-effectiveness&quot;</span>
<span class="sd">                - &quot;equal-mean-recourse&quot;</span>
<span class="sd">                - &quot;fair-tradeoff&quot;</span>

<span class="sd">                Defaults to &quot;equal-effectiveness&quot;.</span>

<span class="sd">                For explanation of each of those metrics, refer either to the</span>
<span class="sd">                paper [#FACTS23]_ or the demo_FACTS notebook.</span>

<span class="sd">            viewpoint (str, optional): &quot;macro&quot; or &quot;micro&quot;. Refers to the</span>
<span class="sd">                notions of &quot;macro viewpoint&quot; and &quot;micro viewpoint&quot; defined</span>
<span class="sd">                in section 2.2 of the paper [#FACTS23]_.</span>

<span class="sd">                As a short explanation, consider a set of actions A and a</span>
<span class="sd">                subgroup (cohort / set of individuals) G. Metrics with the</span>
<span class="sd">                macro viewpoint interpretation are constrained to always apply</span>
<span class="sd">                one action from A to the entire G, while metrics with the micro</span>
<span class="sd">                interpretation are allowed to give each individual in G the</span>
<span class="sd">                min-cost action from A which changes the individual&#39;s class.</span>

<span class="sd">                Note that not all combinations of `metric` and `viewpoint` are</span>
<span class="sd">                valid, e.g. &quot;Equal Choice for Recourse&quot; only has a macro</span>
<span class="sd">                interpretation.</span>

<span class="sd">                Defaults to &quot;macro&quot;.</span>

<span class="sd">            sort_strategy (str, optional): one of the following choices</span>

<span class="sd">                - `&quot;max-cost-diff-decr&quot;`: simply rank the groups in descending \</span>
<span class="sd">                    order according to the unfairness metric.</span>
<span class="sd">                - `&quot;max-cost-diff-decr-ignore-forall-subgroups-empty&quot;`: ignore \</span>
<span class="sd">                    groups for which we have no available actions whatsoever.</span>
<span class="sd">                - `&quot;max-cost-diff-decr-ignore-exists-subgroup-empty&quot;`: ignore \</span>
<span class="sd">                    groups for which at least one protected subgroup has \</span>
<span class="sd">                    no available actions.</span>

<span class="sd">                Defaults to &quot;max-cost-diff-decr&quot;.</span>

<span class="sd">            top_count (int, optional): the number of subpopulation groups that</span>
<span class="sd">                the algorithm will keep.</span>
<span class="sd">                Defaults to 10.</span>

<span class="sd">            filter_sequence (List[str], optional): List of various filters</span>
<span class="sd">                applied on the groups and / or actions. Available filters are:</span>

<span class="sd">                - `&quot;remove-contained&quot;`: does not show groups which are subsumed \</span>
<span class="sd">                    by other shown groups. By &quot;subsumed&quot; we mean that the group \</span>
<span class="sd">                    is defined by extra feature values, but those values are \</span>
<span class="sd">                    not changed by any action.</span>
<span class="sd">                - `&quot;remove-below-thr-corr&quot;`: does not show actions which are \</span>
<span class="sd">                    below the given effectiveness threshold. Refer also to the \</span>
<span class="sd">                    documentation of parameter `phi` below.</span>
<span class="sd">                - `&quot;remove-above-thr-cost&quot;`: does not show action that cost more \</span>
<span class="sd">                    than the given cost budget. Refer also to the documentation \</span>
<span class="sd">                    of parameter `c` below.</span>
<span class="sd">                - `&quot;keep-rules-until-thr-corr-reached&quot;`:</span>
<span class="sd">                - `&quot;remove-fair-rules&quot;`: do not show groups which do not exhibit \</span>
<span class="sd">                    bias.</span>
<span class="sd">                - `&quot;keep-only-min-change&quot;`: for each group shown, show only the \</span>
<span class="sd">                    suggested actions that have minimum cost, ignore the others.</span>

<span class="sd">                Defaults to [].</span>

<span class="sd">            phi (float, optional): effectiveness threshold. Real number in [0, 1].</span>
<span class="sd">                Applicable for &quot;equal-choice-for-recourse&quot; and</span>
<span class="sd">                &quot;equal-cost-of-effectiveness&quot; metrics. For these two metrics, an</span>
<span class="sd">                action is considered to achieve recourse for a subpopulation group</span>
<span class="sd">                if at least `phi` % of the group&#39;s individuals achieve recourse.</span>
<span class="sd">                Defaults to 0.5.</span>

<span class="sd">            c (float, optional): cost budget. Real number. Applicable for</span>
<span class="sd">                &quot;equal-effectiveness-within-budget&quot; metric. Specifies the maximum</span>
<span class="sd">                cost that can be payed for an action (by the individual, by a</span>
<span class="sd">                central authority etc.)</span>
<span class="sd">                Defaults to 0.5.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="k">if</span> <span class="n">viewpoint</span> <span class="o">==</span> <span class="s2">&quot;macro&quot;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_by_if</span>
        <span class="k">elif</span> <span class="n">viewpoint</span> <span class="o">==</span> <span class="s2">&quot;micro&quot;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_with_cumulative</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;viewpoint parameter can be either &#39;macro&#39; or &#39;micro&#39;&quot;</span><span class="p">)</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_by_if</span> <span class="k">if</span> <span class="n">viewpoint</span> <span class="o">==</span> <span class="s2">&quot;macro&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_with_cumulative</span>

        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;fair-tradeoff&quot;</span><span class="p">:</span>
            <span class="n">preds_Xtest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
            <span class="n">pop_sizes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">sg</span><span class="p">:</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prot_attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">sg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">preds_Xtest</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">sg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">prot_attr</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_rules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfairness</span> <span class="o">=</span> <span class="n">select_rules_subset_KStest</span><span class="p">(</span>
                <span class="n">rulesbyif</span><span class="o">=</span><span class="n">rules</span><span class="p">,</span>
                <span class="n">affected_population_sizes</span><span class="o">=</span><span class="n">pop_sizes</span><span class="p">,</span>
                <span class="n">top_count</span><span class="o">=</span><span class="n">top_count</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_costs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_rules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_costs</span> <span class="o">=</span> <span class="n">select_rules_subset</span><span class="p">(</span>
                <span class="n">rulesbyif</span><span class="o">=</span><span class="n">rules</span><span class="p">,</span>
                <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                <span class="n">sort_strategy</span><span class="o">=</span><span class="n">sort_strategy</span><span class="p">,</span>
                <span class="n">top_count</span><span class="o">=</span><span class="n">top_count</span><span class="p">,</span>
                <span class="n">filter_sequence</span><span class="o">=</span><span class="n">filter_sequence</span><span class="p">,</span>
                <span class="n">cor_threshold</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span>
                <span class="n">cost_threshold</span><span class="o">=</span><span class="n">c</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unfairness</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FACTS.print_recourse_report">
<a class="viewcode-back" href="../../../../facts.html#humancompatible.explain.facts.__init__.FACTS.print_recourse_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_recourse_report</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">population_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">missing_subgroup_val</span><span class="o">=</span><span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
        <span class="n">show_subgroup_costs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_action_costs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_cumulative_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">show_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show_unbiased_subgroups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">correctness_metric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prints a nicely formatted report of the results (subpopulation groups</span>
<span class="sd">        and recourses) discovered by the `bias_scan` method.</span>

<span class="sd">        Args:</span>
<span class="sd">            population_sizes (dict(str, int), optional): Number of individuals that</span>
<span class="sd">                are given the negative prediction by the model, for each subgroup.</span>
<span class="sd">                If given, it is included in the report together with some</span>
<span class="sd">                coverage percentages.</span>
<span class="sd">            missing_subgroup_val (str, optional): Optionally specify a value of the</span>
<span class="sd">                protected attribute which denotes that it is missing and should not be</span>
<span class="sd">                included in the printed results.</span>
<span class="sd">                Defaults to &quot;N/A&quot;.</span>
<span class="sd">            show_subgroup_costs (bool, optional): Whether to show the costs assigned</span>
<span class="sd">                to each protected subgroup.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            show_action_costs (bool, optional): Whether to show the costs assigned</span>
<span class="sd">                to each specific action.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            show_cumulative_plots (bool, optional): If true, shows, for each subgroup,</span>
<span class="sd">                a graph of the `effectiveness cumulative distribution`, as it is</span>
<span class="sd">                called in [#FACTS23]_.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            show_bias (str, optional): Specify which value of the protected</span>
<span class="sd">                attribute corresponds to the subgroup against which we want to find</span>
<span class="sd">                unfairness. Mainly useful for when the protected attribute is not</span>
<span class="sd">                binary (e.g. race).</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            correctness_metric (bool, optional): if True, the metric is considered</span>
<span class="sd">                to quantify utility, i.e. the greater it is for a group, the</span>
<span class="sd">                more beneficial it is for the individuals of the group.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            metric_name (str, optional): If given, it is added to the the printed</span>
<span class="sd">                message for unfairness in a subpopulation group, i.e. the method</span>
<span class="sd">                prints &quot;Bias against females due to &lt;metric_name&gt;&quot;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: if costs for groups and subgroups are empty. Most</span>
<span class="sd">                likely the `bias_scan` method was not run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfairness</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">show_unbiased_subgroups</span><span class="p">:</span>
                <span class="n">mock_subgroup_costs</span> <span class="o">=</span> <span class="p">{</span><span class="n">sg</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dummy&quot;</span><span class="p">:</span> <span class="n">unfairness</span><span class="p">}</span> <span class="k">for</span> <span class="n">sg</span><span class="p">,</span> <span class="n">unfairness</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unfairness</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">rules_to_show</span> <span class="o">=</span> <span class="n">delete_fair_rules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_rules</span><span class="p">,</span> <span class="n">subgroup_costs</span><span class="o">=</span><span class="n">mock_subgroup_costs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rules_to_show</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_rules</span>
            <span class="n">print_recourse_report_KStest_cumulative</span><span class="p">(</span>
                <span class="n">rules_to_show</span><span class="p">,</span>
                <span class="n">population_sizes</span><span class="o">=</span><span class="n">population_sizes</span><span class="p">,</span>
                <span class="n">missing_subgroup_val</span><span class="o">=</span><span class="n">missing_subgroup_val</span><span class="p">,</span>
                <span class="n">unfairness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unfairness</span><span class="p">,</span>
                <span class="n">show_then_costs</span><span class="o">=</span><span class="n">show_action_costs</span><span class="p">,</span>
                <span class="n">show_cumulative_plots</span><span class="o">=</span><span class="n">show_cumulative_plots</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">subgroup_costs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">show_unbiased_subgroups</span><span class="p">:</span>
                <span class="n">rules_to_show</span> <span class="o">=</span> <span class="n">delete_fair_rules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_rules</span><span class="p">,</span> <span class="n">subgroup_costs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup_costs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rules_to_show</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_rules</span>
            <span class="n">print_recourse_report</span><span class="p">(</span>
                <span class="n">rules_to_show</span><span class="p">,</span>
                <span class="n">population_sizes</span><span class="o">=</span><span class="n">population_sizes</span><span class="p">,</span>
                <span class="n">missing_subgroup_val</span><span class="o">=</span><span class="n">missing_subgroup_val</span><span class="p">,</span>
                <span class="n">subgroup_costs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subgroup_costs</span><span class="p">,</span>
                <span class="n">show_subgroup_costs</span><span class="o">=</span><span class="n">show_subgroup_costs</span><span class="p">,</span>
                <span class="n">show_then_costs</span><span class="o">=</span><span class="n">show_action_costs</span><span class="p">,</span>
                <span class="n">show_cumulative_plots</span><span class="o">=</span><span class="n">show_cumulative_plots</span><span class="p">,</span>
                <span class="n">show_bias</span><span class="o">=</span><span class="n">show_bias</span><span class="p">,</span>
                <span class="n">correctness_metric</span><span class="o">=</span><span class="n">correctness_metric</span><span class="p">,</span>
                <span class="n">metric_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_metric</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Either subgroup_costs or unfairness should exist. Did you call `bias_scan`?&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, AutoFair Project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>